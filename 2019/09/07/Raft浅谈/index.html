<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.8.0">
    

    

    



    <meta charset="utf-8">
    
    
    
    <title>Raft浅谈 | 泡壶Java | 浸透人生</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
    <meta name="theme-color" content="#3F51B5">
    
    
    <meta name="keywords" content="">
    <meta name="description" content="分布式一致性(Distributed Consensus)What 分布式环境：复杂，Some of the processes (agents) may fail or be unreliable in other ways 一致性：requires agreement among a number of processes (or agents) for a single data value">
<meta property="og:type" content="article">
<meta property="og:title" content="Raft浅谈">
<meta property="og:url" content="http://andj.me/2019/09/07/Raft浅谈/index.html">
<meta property="og:site_name" content="泡壶Java">
<meta property="og:description" content="分布式一致性(Distributed Consensus)What 分布式环境：复杂，Some of the processes (agents) may fail or be unreliable in other ways 一致性：requires agreement among a number of processes (or agents) for a single data value">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2019/png/457347/1566956207876-4391d331-854b-4838-ba0c-509fb38ad66c.png#align=left&display=inline&height=293&name=consensus.png&originHeight=293&originWidth=541&size=16535&status=done&width=541">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2019/png/457347/1566958856739-ad3d084f-adbb-4f9f-8b72-641feb93c79a.png#align=left&display=inline&height=247&name=Screenshot%20from%202019-08-28%2010-20-28.png&originHeight=247&originWidth=392&size=37206&status=done&width=392">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2019/png/457347/1566959735657-020ad9e5-bd81-4799-9e6b-2b821b2c0425.png#align=left&display=inline&height=192&name=Screenshot%20from%202019-08-28%2010-35-09.png&originHeight=192&originWidth=441&size=40113&status=done&width=441">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2019/png/457347/1566960157811-627cdd28-df0f-48ab-85f3-665535e71ba7.png#align=left&display=inline&height=169&name=Screenshot%20from%202019-08-28%2010-42-17.png&originHeight=331&originWidth=852&size=35827&status=done&width=435">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2019/png/457347/1566960733697-9f454765-cc85-4a22-89ec-077da45c00d1.png#align=left&display=inline&height=300&name=Screenshot%20from%202019-08-28%2010-51-50.png&originHeight=388&originWidth=408&size=18629&status=done&width=315">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2019/png/457347/1566960788345-5e2216f2-2cb2-48e9-b0d8-b9c86d622a7c.png#align=left&display=inline&height=294&name=Screenshot%20from%202019-08-28%2010-52-47.png&originHeight=380&originWidth=408&size=20270&status=done&width=316">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2019/png/457347/1566960866335-7a29ab44-24f1-4788-a33a-4bc8db303615.png#align=left&display=inline&height=296&name=Screenshot%20from%202019-08-28%2010-54-10.png&originHeight=382&originWidth=408&size=28063&status=done&width=316">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2019/png/457347/1566960928944-efcfd092-bd34-4119-a671-9d96b29c8b59.png#align=left&display=inline&height=292&name=Screenshot%20from%202019-08-28%2010-54-58.png&originHeight=387&originWidth=407&size=27120&status=done&width=307">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2019/png/457347/1566962392234-6838d5b2-0871-4bdb-ba64-6754fa4eb355.png#align=left&display=inline&height=301&name=Screenshot%20from%202019-08-28%2011-19-29.png&originHeight=505&originWidth=666&size=68848&status=done&width=397">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2019/png/457347/1566972043233-beeb4e33-7d42-4ab9-8826-3cf265c68fb1.png#align=left&display=inline&height=290&name=Screenshot%20from%202019-08-28%2014-00-22.png&originHeight=558&originWidth=821&size=74359&status=done&width=426">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2019/png/457347/1566992314754-b2579d0f-201c-4ab1-9fd6-229c1db92786.png#align=left&display=inline&height=218&name=Screenshot%20from%202019-08-28%2019-38-16.png&originHeight=440&originWidth=953&size=72011&status=done&width=472">
<meta property="og:updated_time" content="2019-09-07T06:21:01.738Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Raft浅谈">
<meta name="twitter:description" content="分布式一致性(Distributed Consensus)What 分布式环境：复杂，Some of the processes (agents) may fail or be unreliable in other ways 一致性：requires agreement among a number of processes (or agents) for a single data value">
<meta name="twitter:image" content="https://cdn.nlark.com/yuque/0/2019/png/457347/1566956207876-4391d331-854b-4838-ba0c-509fb38ad66c.png#align=left&display=inline&height=293&name=consensus.png&originHeight=293&originWidth=541&size=16535&status=done&width=541">
    
        <link rel="alternate" type="application/atom+xml" title="泡壶Java" href="/atom.xml">
    
    <link rel="shortcut icon" href="/img/AnDJ.png">
    <link rel="stylesheet" href="//unpkg.com/hexo-theme-material-indigo@latest/css/style.css">
    <script>window.lazyScripts=[]</script>

    <!-- custom head -->
    

</head>

<body>
    <div id="loading" class="active"></div>

    <aside id="menu" class="hide">
  <div class="inner flex-row-vertical">
    <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menu-off">
        <i class="icon icon-lg icon-close"></i>
    </a>
    <div class="brand-wrap" style="background-image:url(/img/brand.jpg)">
      <div class="brand">
        <a href="/" class="avatar waves-effect waves-circle waves-light">
          <img src="/img/AnDJ.png">
        </a>
        <hgroup class="introduce">
          <h5 class="nickname">AnDJ</h5>
          <a href="mailto:aptx1376432332@gmail.com" title="aptx1376432332@gmail.com" class="mail">aptx1376432332@gmail.com</a>
        </hgroup>
      </div>
    </div>
    <div class="scroll-wrap flex-col">
      <ul class="nav">
        
            <li class="waves-block waves-effect">
              <a href="/">
                <i class="icon icon-lg icon-home"></i>
                主页
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/archives">
                <i class="icon icon-lg icon-archives"></i>
                Archives
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/tags">
                <i class="icon icon-lg icon-tags"></i>
                Tags
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/categories">
                <i class="icon icon-lg icon-th-list"></i>
                Categories
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="https://github.com/An-DJ" target="_blank">
                <i class="icon icon-lg icon-github"></i>
                Github
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="http://www.weibo.com/An_DJ" target="_blank">
                <i class="icon icon-lg icon-weibo"></i>
                Weibo
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/custom">
                <i class="icon icon-lg icon-link"></i>
                twitter
              </a>
            </li>
        
      </ul>
    </div>
  </div>
</aside>

    <main id="main">
        <header class="top-header" id="header">
    <div class="flex-row">
        <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light on" id="menu-toggle">
          <i class="icon icon-lg icon-navicon"></i>
        </a>
        <div class="flex-col header-title ellipsis">Raft浅谈</div>
        
        <div class="search-wrap" id="search-wrap">
            <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="back">
                <i class="icon icon-lg icon-chevron-left"></i>
            </a>
            <input type="text" id="key" class="search-input" autocomplete="off" placeholder="输入感兴趣的关键字">
            <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="search">
                <i class="icon icon-lg icon-search"></i>
            </a>
        </div>
        
        
        <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menuShare">
            <i class="icon icon-lg icon-share-alt"></i>
        </a>
        
    </div>
</header>
<header class="content-header post-header">

    <div class="container fade-scale">
        <h1 class="title">Raft浅谈</h1>
        <h5 class="subtitle">
            
                <time datetime="2019-09-07T13:39:17.000Z" itemprop="datePublished" class="page-time">
  2019-09-07
</time>


            
        </h5>
    </div>

    


</header>


<div class="container body-wrap">
    
    <aside class="post-widget">
        <nav class="post-toc-wrap post-toc-shrink" id="post-toc">
            <h4>TOC</h4>
            <ol class="post-toc"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#分布式一致性-Distributed-Consensus"><span class="post-toc-number">1.</span> <span class="post-toc-text">分布式一致性(Distributed Consensus)</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#What"><span class="post-toc-number">1.1.</span> <span class="post-toc-text">What</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Description"><span class="post-toc-number">1.2.</span> <span class="post-toc-text">Description</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Where"><span class="post-toc-number">1.3.</span> <span class="post-toc-text">Where</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#一致性协议-Consensus-Protocol"><span class="post-toc-number">1.4.</span> <span class="post-toc-text">一致性协议(Consensus Protocol)</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#Paxos"><span class="post-toc-number">2.</span> <span class="post-toc-text">Paxos</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#Raft"><span class="post-toc-number">3.</span> <span class="post-toc-text">Raft</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#复制状态机-Replicated-state-machines"><span class="post-toc-number">3.1.</span> <span class="post-toc-text">复制状态机 Replicated state machines</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Raft-基础"><span class="post-toc-number">3.2.</span> <span class="post-toc-text">Raft 基础</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#领导选举-leader-election"><span class="post-toc-number">3.3.</span> <span class="post-toc-text">领导选举 leader election</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#日志复制-log-replication"><span class="post-toc-number">3.4.</span> <span class="post-toc-text">日志复制 log replication</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#leader-崩溃带来的问题"><span class="post-toc-number">3.4.1.</span> <span class="post-toc-text">leader 崩溃带来的问题</span></a></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#安全性-safety"><span class="post-toc-number">3.5.</span> <span class="post-toc-text">安全性 safety</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#1-选举限制"><span class="post-toc-number">3.5.1.</span> <span class="post-toc-text">1. 选举限制</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#2-提交之前任期内的日志"><span class="post-toc-number">3.5.2.</span> <span class="post-toc-text">2. 提交之前任期内的日志</span></a></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#客户端交互"><span class="post-toc-number">3.6.</span> <span class="post-toc-text">客户端交互</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Have-a-try"><span class="post-toc-number">3.7.</span> <span class="post-toc-text">Have a try</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#参考"><span class="post-toc-number">4.</span> <span class="post-toc-text">参考</span></a></li></ol>
        </nav>
    </aside>


<article id="post-Raft浅谈" class="post-article article-type-post fade" itemprop="blogPost">

    <div class="post-card">
        <h1 class="post-card-title">Raft浅谈</h1>
        <div class="post-meta">
            <time class="post-time" title="2019-09-07 13:39:17" datetime="2019-09-07T13:39:17.000Z" itemprop="datePublished">2019-09-07</time>

            


            
<span id="busuanzi_container_page_pv" title="文章总阅读量" style="display:none">
    <i class="icon icon-eye icon-pr"></i><span id="busuanzi_value_page_pv"></span>
</span>


        </div>
        <div class="post-content" id="post-content" itemprop="postContent">
            <h2 id="分布式一致性-Distributed-Consensus"><a href="#分布式一致性-Distributed-Consensus" class="headerlink" title="分布式一致性(Distributed Consensus)"></a>分布式一致性(Distributed Consensus)</h2><h3 id="What"><a href="#What" class="headerlink" title="What"></a>What</h3><ul>
<li>分布式环境：复杂，Some of the processes (agents) may fail or be unreliable in other ways</li>
<li>一致性：requires agreement among a number of processes (or agents) for a single data value</li>
<li>单个节点（数据副本）更新，所有节点数据也要相应更新。</li>
</ul>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://cdn.nlark.com/yuque/0/2019/png/457347/1566956207876-4391d331-854b-4838-ba0c-509fb38ad66c.png#align=left&display=inline&height=293&name=consensus.png&originHeight=293&originWidth=541&size=16535&status=done&width=541" alt="分布式一致性图示" title="">
                </div>
                <div class="image-caption">分布式一致性图示</div>
            </figure>
<h3 id="Description"><a href="#Description" class="headerlink" title="Description"></a>Description</h3><p><strong>Termination</strong></p>
<p>Eventually, every correct process decides some value.</p>
<p><strong>Integrity</strong> ( <em>be honest</em> )</p>
<p>If all the correct processes proposed the same value <strong>v</strong>, then any correct process must decide <strong>v</strong>.</p>
<p><strong>Agreement</strong></p>
<p>Every correct process must agree on the same value.</p>
<h3 id="Where"><a href="#Where" class="headerlink" title="Where"></a>Where</h3><ul>
<li>Leader election / Mutual Exclusion</li>
<li>Commit or Abort in distributed transactions</li>
<li>Reaching agreement about which process has failed</li>
<li>Clock phase synchronization</li>
</ul>
<h3 id="一致性协议-Consensus-Protocol"><a href="#一致性协议-Consensus-Protocol" class="headerlink" title="一致性协议(Consensus Protocol)"></a>一致性协议(Consensus Protocol)</h3><ul>
<li>2PC (Two-Phase Commit)</li>
<li>3PC (Three-Phase Commit)</li>
<li>Paxos and its variants</li>
<li>Chubby</li>
<li>ZAB (ZooKeeper Atomic Broadcast)</li>
<li>Raft</li>
<li>…</li>
</ul>
<h2 id="Paxos"><a href="#Paxos" class="headerlink" title="Paxos"></a>Paxos</h2><ul>
<li>Lamport 提出的一种基于消息传递的分布式一致性算法</li>
<li><em>The Part-Time Parliament, 1998</em>，首篇论文，以故事性叙述（同行表示看不懂）</li>
<li><em>Paxos Made Simple, 2001</em>，再篇，算法描述（表示仍然看不懂）</li>
<li>too difficult to understand and implement</li>
<li>产生了许多结合实际的衍生实现</li>
</ul>
<h2 id="Raft"><a href="#Raft" class="headerlink" title="Raft"></a>Raft</h2><ul>
<li>论文: <em>In Search of an Understandable Consensus Algorithm (Extended Version)</em></li>
<li>基于日志复制 ( replicated log )</li>
<li>简单，易懂，易于实现，这是 Raft 的研究目的</li>
<li>Stanford 调查发现，对于学生，Raft 算法比 Paxos 更加易于学习</li>
<li>3 part: <strong>leader election, log replication, and safety</strong></li>
</ul>
<h3 id="复制状态机-Replicated-state-machines"><a href="#复制状态机-Replicated-state-machines" class="headerlink" title="复制状态机 Replicated state machines"></a>复制状态机 Replicated state machines</h3><figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://cdn.nlark.com/yuque/0/2019/png/457347/1566958856739-ad3d084f-adbb-4f9f-8b72-641feb93c79a.png#align=left&display=inline&height=247&name=Screenshot%20from%202019-08-28%2010-20-28.png&originHeight=247&originWidth=392&size=37206&status=done&width=392" alt="复制状态机" title="">
                </div>
                <div class="image-caption">复制状态机</div>
            </figure>  
<ul>
<li>一致性算法管理来自客户端指令的复制日志</li>
<li>状态机从日志中处理相同顺序的相同指令，所以产生的结果一致</li>
<li>保证复制日志相同 –&gt; 保证一致性</li>
</ul>
<h3 id="Raft-基础"><a href="#Raft-基础" class="headerlink" title="Raft 基础"></a>Raft 基础</h3><ul>
<li>Raft 集群中包含若干节点，通常是5个</li>
<li>半数以上的节点存活，保持可用性</li>
<li>节点角色状态机（3种角色）</li>
</ul>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://cdn.nlark.com/yuque/0/2019/png/457347/1566959735657-020ad9e5-bd81-4799-9e6b-2b821b2c0425.png#align=left&display=inline&height=192&name=Screenshot%20from%202019-08-28%2010-35-09.png&originHeight=192&originWidth=441&size=40113&status=done&width=441" alt="role 状态机" title="">
                </div>
                <div class="image-caption">role 状态机</div>
            </figure>
<ul>
<li>通常情况下，系统中只有一个 leader ，其他都是 follower</li>
<li>如果客户端与其中一个 follower，其会请求重定向</li>
<li>领导人任期</li>
</ul>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://cdn.nlark.com/yuque/0/2019/png/457347/1566960157811-627cdd28-df0f-48ab-85f3-665535e71ba7.png#align=left&display=inline&height=169&name=Screenshot%20from%202019-08-28%2010-42-17.png&originHeight=331&originWidth=852&size=35827&status=done&width=435" alt="任期示例" title="">
                </div>
                <div class="image-caption">任期示例</div>
            </figure>
<ul>
<li>每一段任期都是从一次选举开始，任期内 leader 唯一且发挥作用</li>
<li>任期是一种逻辑时钟，任期号单调增</li>
<li>某个 leader 发现有节点任期号比自己大？ 切换为 follower</li>
<li>某个请求不属于该任期处理？拒绝</li>
</ul>
<h3 id="领导选举-leader-election"><a href="#领导选举-leader-election" class="headerlink" title="领导选举 leader election"></a>领导选举 <strong>leader election</strong></h3><p>集群初始化 or 当现存的领导人宕机的时候，一个新的领导人需要被选举出来。</p>
<ul>
<li>心跳机制：候选人拉票，半数以上赞同即成为下一任 leader</li>
</ul>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://cdn.nlark.com/yuque/0/2019/png/457347/1566960733697-9f454765-cc85-4a22-89ec-077da45c00d1.png#align=left&display=inline&height=300&name=Screenshot%20from%202019-08-28%2010-51-50.png&originHeight=388&originWidth=408&size=18629&status=done&width=315" alt="等待 leader" title="">
                </div>
                <div class="image-caption">等待 leader</div>
            </figure>      
<p><img src="https://cdn.nlark.com/yuque/0/2019/png/457347/1566960788345-5e2216f2-2cb2-48e9-b0d8-b9c86d622a7c.png#align=left&amp;display=inline&amp;height=294&amp;name=Screenshot%20from%202019-08-28%2010-52-47.png&amp;originHeight=380&amp;originWidth=408&amp;size=20270&amp;status=done&amp;width=316" alt="S1 成为 candidate"><br><figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://cdn.nlark.com/yuque/0/2019/png/457347/1566960866335-7a29ab44-24f1-4788-a33a-4bc8db303615.png#align=left&display=inline&height=296&name=Screenshot%20from%202019-08-28%2010-54-10.png&originHeight=382&originWidth=408&size=28063&status=done&width=316" alt="投票且 S2 成为 candidate" title="">
                </div>
                <div class="image-caption">投票且 S2 成为 candidate</div>
            </figure><br><img src="https://cdn.nlark.com/yuque/0/2019/png/457347/1566960928944-efcfd092-bd34-4119-a671-9d96b29c8b59.png#align=left&amp;display=inline&amp;height=292&amp;name=Screenshot%20from%202019-08-28%2010-54-58.png&amp;originHeight=387&amp;originWidth=407&amp;size=27120&amp;status=done&amp;width=307" alt="S1 当选为 leader"></p>
<ul>
<li><strong>选举 RPC</strong>，会带有部分信息，如任期号</li>
<li>选举结果：自己是 leader；别的节点是 leader；超时没选出来</li>
<li>选举先来先服务</li>
<li>RPC心跳包 任期号比自己的小？不选它</li>
<li>没选出来怎么办？选举超时，可以再选一次</li>
<li>一直超时一直选怎么办？随机指定超时时间</li>
<li><strong>总是能选出有且只有一个 leader</strong></li>
</ul>
<h3 id="日志复制-log-replication"><a href="#日志复制-log-replication" class="headerlink" title="日志复制 log replication"></a>日志复制 <strong>log replication</strong></h3><p>一旦一个 leader 被选出来，它便可以对客户端进行服务。leader 必须从客户端接收日志然后复制到集群中的其他节点，且强制要求其他节点的日志保持和自己相同。</p>
<ul>
<li>流程：客户端发起指令日志 <br>–&gt; leader 存储日志并发送复制RPC给其他节点（通信存在问题，会不断进行尝试） <br>–&gt; 被安全复制后，leader 将其执行到自身的状态机，返回结果给客户端 <br>–&gt; 其他节点执行</li>
</ul>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://cdn.nlark.com/yuque/0/2019/png/457347/1566962392234-6838d5b2-0871-4bdb-ba64-6754fa4eb355.png#align=left&display=inline&height=301&name=Screenshot%20from%202019-08-28%2011-19-29.png&originHeight=505&originWidth=666&size=68848&status=done&width=397" alt="日志复制" title="">
                </div>
                <div class="image-caption">日志复制</div>
            </figure>
<ul>
<li>日志有序号，有创建时的任期号，有操作指令</li>
<li>日志复制RPC，</li>
<li>大多数节点日志复制成功，leader 则提交，通过心跳告知其他节点执行到状态机</li>
<li>leader 保存跟踪最大可以提交的日志 index</li>
</ul>
<p><strong>日志匹配特性</strong></p>
<ul>
<li>如果在不同的日志中的两个条目拥有相同的索引和任期号，那么他们存储了相同的指令</li>
<li>如果在不同的日志中的两个条目拥有相同的索引和任期号，那么他们之前的所有日志条目也全部相同</li>
</ul>
<h4 id="leader-崩溃带来的问题"><a href="#leader-崩溃带来的问题" class="headerlink" title="leader 崩溃带来的问题"></a>leader 崩溃带来的问题</h4><p>follower 可能有当前 leader 有的条目，也可能缺少当前 leader 部分条目，也可能兼有。如下一种情况：</p>
<p><figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://cdn.nlark.com/yuque/0/2019/png/457347/1566972043233-beeb4e33-7d42-4ab9-8826-3cf265c68fb1.png#align=left&display=inline&height=290&name=Screenshot%20from%202019-08-28%2014-00-22.png&originHeight=558&originWidth=821&size=74359&status=done&width=426" alt="leader 崩溃带来的问题" title="">
                </div>
                <div class="image-caption">leader 崩溃带来的问题</div>
            </figure><br><br><br>可能产生这样的原因是：f 当选为 leader，写入日志后没有成功复制就崩溃了；很快 f 机器又重启了，又再次被选为 leader，写入日志后又再次崩溃了，之后是 e，等等。最终会造成上图的结果。leader 是第一行的机器，任期为8。<br><br><br><strong>解决办法</strong><br>强制 follower 直接复制 leader 的日志。</p>
<ul>
<li>leader 从日志最后一条开始往前找，一个对应其他follower的 nextIndex[] 数组维护，初始为leader尾index+1；</li>
<li>每次尝试写入 follower ，不一致则 nextIndex-1，直到找到一致的地方；</li>
<li>强制复制 leader nextIndex 到末尾的部分给 follower</li>
<li><strong>保证了日志匹配特性！</strong></li>
</ul>
<h3 id="安全性-safety"><a href="#安全性-safety" class="headerlink" title="安全性 safety"></a>安全性 <strong>safety</strong></h3><p>前述算法实际上并不能够充分保证每一个状态机会按照相同的顺序执行相同的指令，会存在一些问题，比如 leader 提交日志， 但某个 follower 变为不可用，之后该 follower 被选举为 leader，并且覆盖了这些日志条目。因此，可能存在不同的状态机执行不同的指令序列。</p>
<p>如下有<strong>两处</strong>规则限制：</p>
<h4 id="1-选举限制"><a href="#1-选举限制" class="headerlink" title="1. 选举限制"></a>1. 选举限制</h4><ul>
<li>leader 必须包含所有的已 commit 的日志</li>
<li>选 leader 时，必须遵循如上规则，方法是，投票人会投给与大多数节点一样“新”的节点；拒绝非新节点</li>
<li>新？比较条件是，两份日志最后条目任期号大的较“新”，任期号一致则日志较长的“新”</li>
</ul>
<p><strong>这里论文里没有给出更细致的说明，需要考虑的问题是，为什么这样的策略选出来的leader一定是包含所有已提交的日志的？</strong></p>
<ul>
<li>实际上确实是这样的</li>
</ul>
<h4 id="2-提交之前任期内的日志"><a href="#2-提交之前任期内的日志" class="headerlink" title="2. 提交之前任期内的日志"></a>2. 提交之前任期内的日志</h4><p><figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://cdn.nlark.com/yuque/0/2019/png/457347/1566992314754-b2579d0f-201c-4ab1-9fd6-229c1db92786.png#align=left&display=inline&height=218&name=Screenshot%20from%202019-08-28%2019-38-16.png&originHeight=440&originWidth=953&size=72011&status=done&width=472" alt="是否提交之前任期内的日志" title="">
                </div>
                <div class="image-caption">是否提交之前任期内的日志</div>
            </figure><br><br><br>考虑如上问题。S1作为 leader，任期为2，复制到S2后崩溃；再次选举，S5获选为leader，任期为3，写入自身日志后崩溃；再次选举，S1的末尾日志是最新的，可以获选为leader，任期为4，此时将自己的日志复制到了S3，保证了大多数节点都复制了日志。<br><br><br><strong>这里问题来了：此时S1符合commit的条件，那么到底是提交呢还是不提交？</strong></p>
<ul>
<li>如果提交，情况为d。提交后，S1崩溃，此时集群中的节点最新的节点为S5（因为尾日志任期最新），并且会进行日志复制，这样的话，就会将之前的任期为2的日志覆盖！这样的话，集群中的节点部分就会缺失term 2的操作！</li>
</ul>
<p><strong>其实，实际上需要解决的是，在leader崩溃后，S5这样的节点不能被选为leader！</strong></p>
<ul>
<li>如果不提交，情况为e。S1崩溃的话，不会发生上述问题。S1不崩溃的话，在任期4生成日志并复制到大多数节点，然后再提交，这样的话，如果此时S1崩溃，S5并不能当选（想想为什么），因此解决了问题。</li>
</ul>
<h3 id="客户端交互"><a href="#客户端交互" class="headerlink" title="客户端交互"></a>客户端交互</h3><ul>
<li>支持线性化语义</li>
<li>客户端请求 -&gt; 任一服务器，非 leader 则会转发</li>
<li>leader 崩溃？超时重发。这样会有幂等性问题（使用序列号解决）</li>
<li>只读的操作，可以不需要记录日志，但也会有问题：脏读（可能产生了新的 leader）</li>
<li>脏读解决方式：心跳 ReadIndex or 租约 lease</li>
<li>ReadIndex<ul>
<li>与其他的节点发心跳，肯定自己为 leader</li>
</ul>
</li>
<li>lease<ul>
<li>取一个小于 Election Timeout的时间作为租期</li>
<li>租期内不发生选举</li>
<li>非常依赖时间，不能有太大的误差</li>
</ul>
</li>
</ul>
<h3 id="Have-a-try"><a href="#Have-a-try" class="headerlink" title="Have a try"></a>Have a try</h3><p>动手实现Raft：<br><a href="https://pdos.csail.mit.edu/6.824/labs/lab-raft.html" target="_blank" rel="noopener">https://pdos.csail.mit.edu/6.824/labs/lab-raft.html</a><br></p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://raft.github.io/" target="_blank" rel="noopener">https://raft.github.io/</a><br><a href="https://raft.github.io/raft.pdf" target="_blank" rel="noopener">https://raft.github.io/raft.pdf</a><br><a href="https://github.com/maemual/raft-zh_cn/blob/master/raft-zh_cn.md" target="_blank" rel="noopener">https://github.com/maemual/raft-zh_cn/blob/master/raft-zh_cn.md</a><br><a href="https://pingcap.github.io/blog-cn/linearizability-and-raft/" target="_blank" rel="noopener">https://pingcap.github.io/blog-cn/linearizability-and-raft/</a><br><a href="http://homepage.divms.uiowa.edu/~ghosh/16612.week11.pdf" target="_blank" rel="noopener">http://homepage.divms.uiowa.edu/~ghosh/16612.week11.pdf</a><br><a href="https://en.wikipedia.org/wiki/Consensus_(computer_science" target="_blank" rel="noopener">https://en.wikipedia.org/wiki/Consensus_(computer_science)</a>)</p>
<p>董峻铎，于2019年8月29日，小米武汉</p>

        </div>

        <blockquote class="post-copyright">
    
    <div class="content">
        
<span class="post-time">
    最后更新时间：<time datetime="2019-09-07T06:21:01.738Z" itemprop="dateUpdated">2019-09-07 06:21:01</time>
</span><br>


        
        这里可以写作者留言，标签和 hexo 中所有变量及辅助函数等均可调用，示例:<a href="/2019/09/07/Raft浅谈/" target="_blank" rel="external">http://andj.me/2019/09/07/Raft浅谈/</a>
        
    </div>
    
    <footer>
        <a href="http://andj.me">
            <img src="/img/AnDJ.png" alt="AnDJ">
            AnDJ
        </a>
    </footer>
</blockquote>

        
<div class="page-reward">
    <a id="rewardBtn" href="javascript:;" class="page-reward-btn waves-effect waves-circle waves-light">赏</a>
</div>



        <div class="post-footer">
            

            
<div class="page-share-wrap">
    

<div class="page-share" id="pageShare">
    <ul class="reset share-icons">
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=http://andj.me/2019/09/07/Raft浅谈/&title=《Raft浅谈》 — 泡壶Java&pic=http://andj.me/img/AnDJ.png" data-title="微博">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=http://andj.me/2019/09/07/Raft浅谈/&title=《Raft浅谈》 — 泡壶Java&source=写一写-from AnDJ" data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=http://andj.me/2019/09/07/Raft浅谈/" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《Raft浅谈》 — 泡壶Java&url=http://andj.me/2019/09/07/Raft浅谈/&via=http://andj.me" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=http://andj.me/2019/09/07/Raft浅谈/" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
    </ul>
 </div>



    <a href="javascript:;" id="shareFab" class="page-share-fab waves-effect waves-circle">
        <i class="icon icon-share-alt icon-lg"></i>
    </a>
</div>



        </div>
    </div>

    
<nav class="post-nav flex-row flex-justify-between flex-row-reverse">
  

  
    <div class="waves-block waves-effect next">
      <a href="/2019/09/07/hello-world/" id="post-next" class="post-nav-link">
        <div class="tips">Next <i class="icon icon-angle-right icon-lg icon-pl"></i></div>
        <h4 class="title">Hello World</h4>
      </a>
    </div>
  
</nav>



    











    <!-- Valine Comments -->
    <div class="comments vcomment" id="comments"></div>
    <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
    <script src="//unpkg.com/valine@latest/dist/Valine.min.js"></script>
    <!-- Valine Comments script -->
    <script>
        var GUEST_INFO = ['nick','mail','link'];
        var guest_info = 'nick,mail,link'.split(',').filter(function(item){
          return GUEST_INFO.indexOf(item) > -1
        });
        new Valine({
            el: '#comments',
            notify: 'false' == 'true',
            verify: 'false' == 'true',
            appId: "cKw8onRSaLp3yJpocc8NIP3o-gzGzoHsz",
            appKey: "VvRtaWv3T4EvOcdJw5VGvtKo",
            avatar: "mm",
            placeholder: "Just go go",
            guest_info: guest_info.length == 0 ? GUEST_INFO : guest_info,
            pageSize: "10"
        })
    </script>
    <!-- Valine Comments end -->




</article>

<div id="reward" class="page-modal reward-lay">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <h3 class="reward-title">
        <i class="icon icon-quote-left"></i>
        多谢捧场~
        <i class="icon icon-quote-right"></i>
    </h3>
    <div class="reward-content">
        
        <div class="reward-code">
            <img id="rewardCode" src="/img/wechat.png" alt="打赏二维码">
        </div>
        
        <label class="reward-toggle">
            <input id="rewardToggle" type="checkbox" class="reward-toggle-check" data-wechat="/img/wechat.png" data-alipay="/img/alipay.png">
            <div class="reward-toggle-ctrol">
                <span class="reward-toggle-item wechat">微信</span>
                <span class="reward-toggle-label"></span>
                <span class="reward-toggle-item alipay">支付宝</span>
            </div>
        </label>
        
    </div>
</div>



</div>

        <footer class="footer">
    <div class="top">
        
<p>
    <span id="busuanzi_container_site_uv" style="display:none">
        站点总访客数<span id="busuanzi_value_site_uv"></span>
    </span>
    <span id="busuanzi_container_site_pv" style="display:none">
        站点总访问量<span id="busuanzi_value_site_pv"></span>
    </span>
</p>


        <p>
            
                <span><a href="/atom.xml" target="_blank" class="rss" title="rss"><i class="icon icon-lg icon-rss"></i></a></span>
            
            <span>博客内容遵循 <a rel="license" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh">知识共享 署名 - 非商业性 - 相同方式共享 4.0 国际协议</a></span>
        </p>
    </div>
    <div class="bottom">
        <p><span>AnDJ &copy; 2015 - 2019</span>
            <span>
                
                <a href="http://www.miitbeian.gov.cn/" target="_blank">晋ICP备17005941号</a><br>
                
                Power by <a href="http://hexo.io/" target="_blank">Hexo</a> Theme <a href="https://github.com/yscoder/hexo-theme-indigo" target="_blank">indigo</a>
            </span>
        </p>
    </div>
</footer>

    </main>
    <div class="mask" id="mask"></div>
<a href="javascript:;" id="gotop" class="waves-effect waves-circle waves-light"><span class="icon icon-lg icon-chevron-up"></span></a>



<div class="global-share" id="globalShare">
    <ul class="reset share-icons">
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=http://andj.me/2019/09/07/Raft浅谈/&title=《Raft浅谈》 — 泡壶Java&pic=http://andj.me/img/AnDJ.png" data-title="微博">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=http://andj.me/2019/09/07/Raft浅谈/&title=《Raft浅谈》 — 泡壶Java&source=写一写-from AnDJ" data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=http://andj.me/2019/09/07/Raft浅谈/" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《Raft浅谈》 — 泡壶Java&url=http://andj.me/2019/09/07/Raft浅谈/&via=http://andj.me" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=http://andj.me/2019/09/07/Raft浅谈/" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
    </ul>
 </div>


<div class="page-modal wx-share" id="wxShare">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <p>扫一扫，分享到微信</p>
    <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAK4AAACuCAAAAACKZ2kyAAABxklEQVR42u3aQW7DMAwEwPz/0+61h0ZekpaQFKNTgNjy+EKIS79e8bp+rfzKd9fnuzUXLi7umHst1xqxfuS7Hdb/3rwwLi7uQW7ysOo1V7Dy/XFxcT+fe8UrL3O4uLj/g5v8Xh+YcHFxP5mbH0HyIlVtoh7u1XBxcQfcPKXc93tLvouLi9viXsW1visPSXsLFxf3DDcvKPkL9ApiYbiLi4u7mVt9wFPhaa9xwsXFPcNNYtNqqNoLScsjGVxc3CPc6gdVyRFn/chqnIqLi3uem5SP3uGmmnze9Gq4uLhHuMnWvcf0GqpCCcPFxd3AnRSsyQ7Vzz7+mPzg4uJu4/ZakeSuyVcT5eYHFxd3A3ceblbL32h8i4uLe4SbtB+TFyjntUkThYuLu5mbNDDVgUoesiRD3HI4gouL+xC32ro89YlGuaHCxcU9yK3GoJPBavMUhouLe4Tbiy/zoWk1EIk6IVxc3M3cfFUDjkkj1Ct/uLi4z3J7U9n1MWgSp978i4uLe5A7LzTVyDU5MOHi4n4vN487k3J282K4uLgfzJ0MZatRywOFDBcXt8VNmp8qOpnk5B9+4eLinuTmgemO6UZv3IuLi7uN+wPR9iAeeGaRUQAAAABJRU5ErkJggg==" alt="微信分享二维码">
</div>




    <script src="//cdn.bootcss.com/node-waves/0.7.4/waves.min.js"></script>
<script>
var BLOG = { ROOT: '/', SHARE: true, REWARD: true };


</script>

<script src="//unpkg.com/hexo-theme-material-indigo@latest/js/main.min.js"></script>


<div class="search-panel" id="search-panel">
    <ul class="search-result" id="search-result"></ul>
</div>
<template id="search-tpl">
<li class="item">
    <a href="{path}" class="waves-block waves-effect">
        <div class="title ellipsis" title="{title}">{title}</div>
        <div class="flex-row flex-middle">
            <div class="tags ellipsis">
                {tags}
            </div>
            <time class="flex-col time">{date}</time>
        </div>
    </a>
</li>
</template>

<script src="//unpkg.com/hexo-theme-material-indigo@latest/js/search.min.js" async></script>






<script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>



<script>
(function() {
    var OriginTitile = document.title, titleTime;
    document.addEventListener('visibilitychange', function() {
        if (document.hidden) {
            document.title = 'leave';
            clearTimeout(titleTime);
        } else {
            document.title = 'back';
            titleTime = setTimeout(function() {
                document.title = OriginTitile;
            },2000);
        }
    });
})();
</script>



</body>
</html>
